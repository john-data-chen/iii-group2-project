# ?程?目??為???QQQ?RSI 2條?交???略下?報????

# 載入RODBC
library(RODBC)
# ODBC ??稱/ user / password
conn <- odbcConnect("mysql", uid="root", pwd="")
# 讀??table
sqlTables(conn)
# 讀??table qqq
priceTab <- sqlFetch(conn,"qqq")
# ?????
close(conn)

# 載入xts
library(xts)
# rownames = date
rownames(priceTab) = priceTab[,1]
# 輸入??測??起點???格式??2009-01-01
fromDate = readline()
backtestTime <- priceTab[rownames(priceTab) > fromDate,]
# ???NULL
backtestTime$Date = NULL
# 轉?為xts
priceXts = as.xts(backtestTime)

# 載入quantmod，??起?入TTR
library(quantmod)

# 輸入?1條??天?，天?必?是較短???這個值?是字????as.numeric??能?
shortDay = readline()
# 計?短天數RSI，收?????4?
a = RSI(as.numeric(priceXts[,4]), n = as.numeric(shortDay))
names(a)= rownames(backtestTime)
rsiShort= as.xts(a)

# 輸入?2條??天?，天?必?是較長???
longDay = readline()
# 計?長天數RSI
a = RSI(as.numeric(priceXts[,4]), n = as.numeric(longDay))
names(a)= rownames(backtestTime)
rsiLong = as.xts(a)

# 策略??測：當?天數rsi > ?天數rsi，全壓?當?天數rsi < ?天數rsi，空???
# position?一??????以???位???短天數rsi大於?天數rsi，設?為1；否??設?為0??
# ????們是?資????發???只???天??交?????這??全?往後?延一天?
position <- Lag(ifelse(rsiShort > rsiLong, 1,0))
# ROC計??log(今天???/?天收??)，??poistion?表。若1?????若0??空???
rsiReturn <- ROC(Cl(backtestTime))*position
# cumsum計?累計值?即將????????值累??起來。?exp???要??累計報????
rsiReturn<- exp(cumsum(rsiReturn[!is.na(rsiReturn)]))

# 顯示??測起?日???
fromDate
# 顯示?天數跟長天數RSI???數
shortDay
longDay
# 顯示從起點???總???幾?交??日
length(rownames(backtestTime))
# 計?總?交?幾次?交??次?越????出???費跟?就越??
tradeTotal = sum(position -  Lag(position,1) !=0, na.rm=TRUE)
tradeTotal
# 累?報???畫???表
plot(rsiReturn)
